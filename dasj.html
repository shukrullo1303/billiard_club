{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Table Dashboard</title>
    <style>
      body {
        background: #1c1c1e;
        color: white;
        font-family: sans-serif;
        margin: 0;
        padding: 0;
      }
      h1 {
        text-align: center;
        margin-top: 20px;
      }
      .table-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 20px;
      }
      .table-card {
        background: #2c2c2e;
        border-radius: 20px;
        padding: 20px;
        text-align: center;
        position: relative;
      }
      .table-number {
        font-size: 1.2rem;
        color: #8e8e93;
      }
      .timer-price {
        display: flex;
        justify-content: center;
        gap: 10px;
        font-size: 1.2rem;
        margin-top: 10px;
      }
      .btn {
        width: 60px;
        height: 30px;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        margin: 5px;
      }
      .start {
        background: #4cd964;
        color: white;
      }
      .stop {
        background: #ff3b30;
        color: white;
      }
      .status {
        margin-top: 10px;
        font-weight: bold;
      }
      .session-list-container {
        max-height: 150px;
        overflow-y: auto;
        margin-top: 15px;
      }
      .session-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .session-list li {
        background: #3a3a3c;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .session-list li button {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        border: none;
        background: #4cd964;
        color: white;
        cursor: pointer;
        font-size: 14px;
      }
      .paid-session-list-container {
        max-height: 300px;
        overflow-y: auto;
        margin: 20px;
      }
      .paid-session-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .paid-session-list li {
        background: #2a2a2c;
        padding: 6px;
        margin-bottom: 4px;
        border-radius: 8px;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <h1>Table Dashboard</h1>

    <div class="table-container">
      {% for table in tables %}
      <div
        class="table-card"
        id="table-{{ table.id }}"
        data-price="{{ table.price_per_hour }}"
      >
        <div class="table-number">
          {{ table.number }} - {{ table.table_type }}
        </div>
        <div class="timer-price">
          <span class="timer" id="timer-{{ table.id }}">00:00</span>
          <span class="price" id="price-{{ table.id }}">0.00</span>
        </div>
        <div style="display: flex; justify-content: center; margin-top: 10px">
          <button
            class="btn start"
            id="start-{{ table.id }}"
            onclick="startSession({{ table.id }})"
            {%
            if
            table.is_active
            %}disabled{%
            endif
            %}
          >
            START
          </button>
          <button
            class="btn stop"
            id="stop-{{ table.id }}"
            onclick="stopSession({{ table.id }})"
            {%
            if
            not
            table.is_active
            %}disabled{%
            endif
            %}
          >
            STOP
          </button>
        </div>
        <div class="status" id="status-{{ table.id }}">
          {{ table.is_active|yesno:"BAND,BO'SH" }}
        </div>

        <!-- Waiting payment sessions inside card -->
        <div class="session-list-container">
          <ul class="session-list" id="session-list-{{ table.id }}">
            {% for session in table.sessions.all %} {% if session.status != 'active' and not session.payment_done %}
            <li id="session-{{ session.id }}">
              {{ table.number }} - {{ session.total_price }}
              <button onclick="paySession({{ session.id }})">x</button>
            </li>
            {% endif %} {% endfor %}
          </ul>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Paid sessions list at the bottom -->
    <!-- Paid sessions list at the bottom -->
    <h2
      style="
        margin-left: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      "
    >
      Paid Sessions (Today)
    </h2>

    <p id="total-income" style="margin-left: 20px">
      Bugungi foyda: {{ total_income }} so'm
    </p>
    <div class="paid-session-list-container">
      <ul class="paid-session-list" id="paid-sessions-list">
        {% for session in paid_sessions %}
        <li id="paid-session-{{ session.id }}">
          {{ session.table.number }} - {{ session.total_price }} (Paid)
        </li>
        {% empty %}
        <li>Bugun hali toâ€˜lov qilinmagan.</li>
        {% endfor %}
      </ul>
    </div>

    <script>
      const timers = {};

      function startSession(tableId) {
        fetch(`/sessions/start/${tableId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              document.getElementById(`status-${tableId}`).textContent = "BAND";
              document.getElementById(`start-${tableId}`).disabled = true;
              document.getElementById(`stop-${tableId}`).disabled = false;
              startTimer(tableId, new Date(data.start_time));
            }
          });
      }

      function stopSession(tableId) {
        fetch(`/sessions/stop/${tableId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              clearInterval(timers[tableId]);
              document.getElementById(`timer-${tableId}`).textContent = "00:00";
              document.getElementById(`price-${tableId}`).textContent = "0.00";
              document.getElementById(`status-${tableId}`).textContent =
                "BO'SH";
              document.getElementById(`start-${tableId}`).disabled = false;
              document.getElementById(`stop-${tableId}`).disabled = true;

              // add session to waiting payment
              const li = document.createElement("li");
              li.id = `session-${data.session.id}`;
              li.innerHTML = `${data.session.table_number} - ${data.session.price} <button onclick="paySession(${data.session.id})">x</button>`;
              document
                .getElementById(`session-list-${tableId}`)
                .appendChild(li);
            }
          });
      }

      function startTimer(tableId, startTime) {
        const timerEl = document.getElementById(`timer-${tableId}`);
        const priceEl = document.getElementById(`price-${tableId}`);
        const pricePerHour = parseFloat(
          document.getElementById(`table-${tableId}`).dataset.price
        );

        timers[tableId] = setInterval(() => {
          const diff = new Date() - startTime;
          const mins = Math.floor(diff / 60000);
          const secs = Math.floor((diff % 60000) / 1000);
          timerEl.textContent = `${String(mins).padStart(2, "0")}:${String(
            secs
          ).padStart(2, "0")}`;
          const hours = diff / 3600000;
          priceEl.textContent = (hours * pricePerHour).toFixed(2);
        }, 1000);
      }

function paySession(sessionId) {
  fetch(`/sessions/payment/${sessionId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json",
    },
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {

        const oldLi = document.getElementById(`session-${sessionId}`);
        const text = oldLi.innerText.replace("x", "").trim();
        oldLi.remove();

        const paidLi = document.createElement("li");
        paidLi.innerText = text + " (Paid)";
        document.getElementById("paid-sessions-list").appendChild(paidLi);

        document.getElementById("total-income").innerText =
          "Bugungi foyda: " + data.total_income + " so'm";
      }
    });
}

    </script>
  </body>
</html>


</body>
</html>
